<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Swarg Social Â· Login</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <!-- Google Fonts for premium typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">
</head>
<body class="auth-body">
    <div class="glass-panel auth-container">
        <div class="tabs">
            <button class="tab-btn active" id="loginTab">Login</button>
            <button class="tab-btn" id="registerTab">Register</button>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="auth-form active">
            <h2>Welcome back</h2>
            <div class="input-group">
                <input type="text" id="loginIdentifier" placeholder="Username or SSN" required>
                <label>Username / SSN</label>
            </div>
            <div class="input-group">
                <input type="password" id="loginPassword" placeholder="Password" required>
                <label>Password</label>
            </div>
            <button type="submit" class="glass-btn primary">Sign In</button>
        </form>

        <!-- Register Form -->
        <form id="registerForm" class="auth-form">
            <h2>Create account</h2>
            <div class="input-group">
                <input type="text" id="regUsername" placeholder="Username" required>
                <label>Username</label>
            </div>
            <div class="input-group">
                <input type="email" id="regEmail" placeholder="Email" required>
                <label>Email</label>
            </div>
            <div class="input-group">
                <input type="password" id="regPassword" placeholder="Password" required>
                <label>Password</label>
            </div>
            <div class="file-upload glass" id="dpUploadArea">
                <span>Upload Display Picture (max 100MB)</span>
                <input type="file" id="dpFile" accept="image/*" hidden>
                <div class="dp-preview" id="dpPreview"></div>
            </div>
            <button type="submit" class="glass-btn primary">Register & Get SSN</button>
        </form>
    </div>

    <script type="module">
        import { supabase } from './supabase-config.js';
        import { handleLogin, handleRegister, generateSSN } from './auth.js';

        document.addEventListener('DOMContentLoaded', () => {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            loginTab.addEventListener('click', () => {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            });

            registerTab.addEventListener('click', () => {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.classList.add('active');
                loginForm.classList.remove('active');
            });

            // DP preview with compression
            const dpInput = document.getElementById('dpFile');
            const dpArea = document.getElementById('dpUploadArea');
            const dpPreview = document.getElementById('dpPreview');
            dpArea.addEventListener('click', () => dpInput.click());
            dpInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                // compress image
                const compressed = await compressImage(file, 800, 800, 0.8);
                const reader = new FileReader();
                reader.onload = (e) => {
                    dpPreview.style.backgroundImage = `url(${e.target.result})`;
                    dpPreview.classList.add('has-image');
                };
                reader.readAsDataURL(compressed);
                // store compressed file for upload later
                window.regDPFile = compressed;
            });

            // compress function (simple canvas)
            async function compressImage(file, maxWidth, maxHeight, quality) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = URL.createObjectURL(file);
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        }, 'image/jpeg', quality);
                    };
                });
            }

            // login submit
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const identifier = document.getElementById('loginIdentifier').value;
                const password = document.getElementById('loginPassword').value;
                await handleLogin(identifier, password);
            });

            // register submit
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('regUsername').value;
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;
                const dpFile = window.regDPFile;
                await handleRegister(username, email, password, dpFile);
            });
        });
    </script>
</body>
      </html>
