<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swarg · Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="glass-nav">
        <div class="nav-brand">Swarg Social</div>
        <div class="nav-links">
            <a href="dashboard.html">Feed</a>
            <a href="chat.html" class="active">Chat</a>
            <a href="group.html">Groups</a>
            <a href="#" id="profileBtn">Profile</a>
            <button id="logoutBtn" class="glass-btn small">Logout</button>
        </div>
    </nav>

    <main class="chat-container">
        <aside class="glass-card contacts-panel">
            <div class="search-box">
                <input type="text" id="searchUsers" placeholder="Search by username or SSN">
                <button id="addContactBtn">➕</button>
            </div>
            <div id="contactsList"></div>
        </aside>

        <section class="glass-card chat-area">
            <div id="chatHeader" class="chat-header">Select a contact</div>
            <div id="messagesContainer" class="messages"></div>
            <div class="message-input">
                <input type="text" id="messageText" placeholder="Type a message">
                <button id="sendMessageBtn" class="glass-btn primary">Send</button>
            </div>
        </section>
    </main>

    <script type="module">
        import { supabase } from './supabase-config.js';
        import { getCurrentUser, loadContacts, initChat } from './app.js';

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await getCurrentUser();
            if (!user) window.location.href = 'index.html';

            loadContacts();
            initChat();

            document.getElementById('addContactBtn').addEventListener('click', async () => {
                const query = document.getElementById('searchUsers').value;
                // search by username or SSN from profiles table
                const { data } = await supabase
                    .from('profiles')
                    .select('*')
                    .or(`username.eq.${query},ssn.eq.${query}`)
                    .single();
                if (data) {
                    // add to local storage contacts
                    let contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
                    if (!contacts.find(c => c.user_id === data.user_id)) {
                        contacts.push({ user_id: data.user_id, username: data.username, ssn: data.ssn });
                        localStorage.setItem('contacts', JSON.stringify(contacts));
                        loadContacts();
                    }
                } else alert('User not found');
            });
        });
    </script>
</body>
              </html>
